# ğŸ§¾ è‡ªåŠ¨æ›´æ–°ä¸å‘å¸ƒç³»ç»Ÿè§„åˆ’æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

* **é¡¹ç›®åç§°ï¼š** GodForsaken Save Manager
* **ä»“åº“åœ°å€ï¼š** [https://github.com/abevol/godforsaken-save-manager](https://github.com/abevol/godforsaken-save-manager)
* **å¼€å‘è¯­è¨€ä¸æ¡†æ¶ï¼š** Python + PySide6
* **æ‰“åŒ…æ–¹å¼ï¼š** `poetry run nuitka --standalone --onefile ...`
* **ç›®æ ‡å¹³å°ï¼š** Windows 10/11
* **å¯æ‰§è¡Œæ–‡ä»¶åï¼š** `GodForsakenSaveManager.exe`
* **åˆ†å‘ç›®æ ‡ï¼š** ç”¨æˆ·å¯å…¬å¼€è®¿é—®æœ€æ–°ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶å¹¶è‡ªåŠ¨æ›´æ–°
* **æºç çŠ¶æ€ï¼š** å…¬å¼€ï¼ˆPublicï¼‰

---

## 1ï¸âƒ£ ç›®æ ‡ä¸çº¦æŸ

### ğŸ¯ ç›®æ ‡

1. **è‡ªåŠ¨åŒ–æ„å»ºä¸å‘å¸ƒ**

   * å½“ä»“åº“æ‰“ä¸Šæ–° tagï¼ˆå¦‚ `v1.4.0`ï¼‰æ—¶ï¼ŒGitHub Actions è‡ªåŠ¨æ‰§è¡Œï¼š

     * æ‹‰å–æºç ï¼›
     * ä½¿ç”¨ Poetry + Nuitka æ„å»ºï¼›
     * ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼›
     * è®¡ç®—æ ¡éªŒä¿¡æ¯ï¼›
     * ç”Ÿæˆ `version.json`ï¼›
     * ä¸Šä¼ åˆ° GitHub Releaseï¼ˆå…¬å¼€ï¼‰ã€‚

2. **è‡ªåŠ¨æ›´æ–°æœºåˆ¶**

   * ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥ GitHub ä¸Šæœ€æ–°ç‰ˆæœ¬ï¼›
   * è‹¥æœ‰æ›´æ–°åˆ™æç¤ºç”¨æˆ·ï¼›
   * è‡ªåŠ¨ä¸‹è½½æ–°ç‰ˆ `.exe`ï¼›
   * æ ¡éªŒ SHA256ï¼›
   * æ›¿æ¢æˆ–å¯åŠ¨æ–°ç‰ˆæœ¬ã€‚

3. **å…è´¹ã€é€æ˜**

   * ä½¿ç”¨ GitHub æä¾›çš„å…è´¹åŠŸèƒ½ï¼›
   * æ‰€æœ‰èµ„æºï¼ˆRelease æ–‡ä»¶ã€version.jsonï¼‰å‡å¯å…¬å¼€è®¿é—®ï¼›
   * æ— éœ€é¢å¤–æœåŠ¡å™¨ã€‚

---

## 2ï¸âƒ£ ç³»ç»Ÿæ¶æ„

| æ¨¡å—                  | åŠŸèƒ½è¯´æ˜                       |
| ------------------- | -------------------------- |
| **GitHub ä»“åº“ï¼ˆå…¬å¼€ï¼‰**   | å­˜æ”¾æºç ã€å·¥ä½œæµé…ç½®åŠ Release æ–‡ä»¶     |
| **GitHub Actions**  | è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒç‰ˆæœ¬                  |
| **GitHub Releases** | æ‰˜ç®¡ `.exe` å’Œ `version.json` |
| **å®¢æˆ·ç«¯æ›´æ–°æ¨¡å—**         | æ£€æŸ¥æ›´æ–°ã€ä¸‹è½½æ–°ç‰ˆæœ¬ã€æ‰§è¡Œæ›´æ–°            |

### äº¤äº’æµç¨‹

```
[ç”¨æˆ·å¯åŠ¨åº”ç”¨]
        â”‚
        â–¼
è¯·æ±‚ https://api.github.com/repos/abevol/godforsaken-save-manager/releases/latest
        â”‚
   æ˜¯å¦æœ‰æ›´æ–°ï¼Ÿ
      /   \
    å¦     æ˜¯
    â”‚      â–¼
    â”‚  ä¸‹è½½æ–°ç‰ˆæœ¬ .exe
    â”‚      â”‚
    â”‚  æ ¡éªŒ SHA256
    â”‚      â”‚
    â”‚  å¯åŠ¨æ–°ç‰ˆæœ¬
    â–¼
ç»§ç»­è¿è¡Œ
```

---

## 3ï¸âƒ£ æ–‡ä»¶ä¸æ¥å£è§„èŒƒ

### ğŸ”¹ version.json ç¤ºä¾‹

å­˜æ”¾åœ¨æ¯æ¬¡å‘å¸ƒçš„ Release é™„ä»¶ä¸­ï¼š

```json
{
  "version": "1.4.0",
  "notes": {
    "zh": "æ”¹è¿› UIã€ä¿®å¤å­˜æ¡£è¯†åˆ«é€»è¾‘",
    "en": "Improved UI and fixed save recognition logic"
  },
  "url": "https://github.com/abevol/godforsaken-save-manager/releases/download/v1.4.0/GodForsakenSaveManager.exe",
  "sha256": "2a7bde1d3d4e70f5b8c2a12345678abcd9e...",
  "timestamp": "2025-11-09T10:30:00Z"
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ          | è¯´æ˜          |
| ----------- | ----------- |
| `version`   | ç‰ˆæœ¬å·ï¼ˆå¯¹åº” tagï¼‰ |
| `notes`     | æ›´æ–°è¯´æ˜ï¼ˆä¸­è‹±æ–‡ï¼‰   |
| `url`       | æ–°ç‰ˆæœ¬ä¸‹è½½åœ°å€     |
| `sha256`    | æ–‡ä»¶æ ¡éªŒå“ˆå¸Œå€¼     |
| `timestamp` | æ„å»ºæ—¶é—´ï¼ˆUTCï¼‰   |

---

## 4ï¸âƒ£ è‡ªåŠ¨åŒ–æ„å»ºæµç¨‹ï¼ˆGitHub Actionsï¼‰

### âœ… è§¦å‘æ¡ä»¶

* å½“æ¨é€ tagï¼ˆæ ¼å¼ `vX.Y.Z`ï¼‰åˆ°ä¸»åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œã€‚

### âœ… ç¯å¢ƒè¦æ±‚

* Windows Runner
* Python 3.11
* Poetry + Nuitka

### âœ… å·¥ä½œæµç¤ºä¾‹ `.github/workflows/release.yml`

```yaml
name: Build and Release Public

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry and dependencies
        run: |
          pip install poetry
          poetry install --no-interaction --no-root
      
      - name: Check version consistency
        run: |
          $tag_version = "${{ github.ref_name }}".substring(1)
          $toml_version = poetry version -s
          if ($tag_version -ne $toml_version) {
            echo "Error: Tag version ($tag_version) does not match pyproject.toml version ($toml_version)."
            exit 1
          }

      - name: Build executable with Nuitka
        run: |
          poetry run nuitka src/godforsaken_save_manager/main.py --standalone --onefile --output-filename=GodForsakenSaveManager.exe

      - name: Compute SHA256 hash
        id: hash
        run: |
          $hashValue = (Get-FileHash -Algorithm SHA256 GodForsakenSaveManager.exe).Hash.ToLower()
          echo "sha256=$hashValue" >> $env:GITHUB_OUTPUT

      - name: Get release notes from tag
        id: get_release_notes
        run: |
          $notes = git tag -l --format='%(contents)' ${{ github.ref_name }}
          $notes = $notes -replace '"', '\"' -replace "`n", '\n' -replace "`r", '\r'
          echo "notes=$notes" >> $env:GITHUB_OUTPUT

      - name: Create version.json
        run: |
          $notes_json = "${{ steps.get_release_notes.outputs.notes }}"
          # çº¦å®šä¸­è‹±æ–‡æ›´æ–°è¯´æ˜æ ¼å¼: "ä¸­æ–‡è¯´æ˜ EN: English notes"
          if ($notes_json -like '*EN:*') {
            $zh_notes = ($notes_json.Split('EN:')[0]).Trim()
            $en_notes = ($notes_json.Split('EN:')[1]).Trim()
          } else {
            $zh_notes = $notes_json
            $en_notes = $notes_json
          }
          
          $json = "{ \"version\": \"${{ github.ref_name }}\".substring(1), " +
                  "\"notes\": {\"zh\": \"$zh_notes\", \"en\": \"$en_notes\"}, " +
                  "\"url\": \"https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/GodForsakenSaveManager.exe\", " +
                  "\"sha256\": \"${{ steps.hash.outputs.sha256 }}\", " +
                  "\"timestamp\": \"$(Get-Date -Format o)\" }"
          
          echo $json | Out-File -Encoding utf8 version.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body: ${{ steps.get_release_notes.outputs.notes }}
          files: |
            GodForsakenSaveManager.exe
            version.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 5ï¸âƒ£ å®¢æˆ·ç«¯è‡ªåŠ¨æ›´æ–°æ¨¡å—

æ–‡ä»¶ï¼š`updater.py` (æ ¸å¿ƒé€»è¾‘) ä¸ `main.py` (å…¥å£å¤„ç†)

### ğŸ”´ æ›´æ–°æ›¿æ¢é€»è¾‘ï¼ˆé‡è¦å˜æ›´ï¼‰

åŸæ–¹æ¡ˆæ— æ³•åœ¨ Windows ä¸Šæ›¿æ¢æ­£åœ¨è¿è¡Œçš„ `.exe` æ–‡ä»¶ã€‚æ–°æ–¹æ¡ˆé‡‡ç”¨â€œå¼•å¯¼å¼æ›´æ–°â€ï¼š

1.  **æ—§ç‰ˆç¨‹åº**ï¼šä¸‹è½½æ–°ç‰ˆåˆ°ä¸´æ—¶ç›®å½•ï¼Œå‘½åä¸º `_new.exe`ã€‚
2.  **å¯åŠ¨æ–°ç‰ˆ**ï¼šæ—§ç‰ˆç¨‹åºä»¥ä¸€ä¸ªç‰¹æ®Šå‚æ•°ï¼ˆä¾‹å¦‚ `--perform-update`ï¼‰å¯åŠ¨æ–°ç‰ˆç¨‹åºï¼Œå¹¶å°†è‡ªå·±çš„è·¯å¾„ä½œä¸ºå‚æ•°ä¼ é€’è¿‡å»ï¼Œç„¶åç«‹å³é€€å‡ºã€‚
3.  **æ–°ç‰ˆç¨‹åº**ï¼šåœ¨å¯åŠ¨æ—¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥ç‰¹æ®Šå‚æ•°ã€‚
    *   å¦‚æœå­˜åœ¨ï¼Œåˆ™è¿›å…¥â€œæ›´æ–°æ¨¡å¼â€ï¼šç­‰å¾…æ—§è¿›ç¨‹å®Œå…¨é€€å‡ºï¼Œç„¶åå°†è‡ªå·±ï¼ˆæ–°ç‰ˆ `.exe`ï¼‰å¤åˆ¶å¹¶è¦†ç›–åˆ°æ—§ç‰ˆç¨‹åºçš„ä½ç½®ã€‚
    *   å®Œæˆè¦†ç›–åï¼Œä»¥æ­£å¸¸æ¨¡å¼é‡æ–°å¯åŠ¨ï¼Œå®ç°æ— ç¼æ›´æ–°ã€‚

### âœ³ï¸ ç‰ˆæœ¬å·è·å–

ç‰ˆæœ¬å·ä¸å†ç¡¬ç¼–ç ï¼Œè€Œæ˜¯ä» `pyproject.toml` åŠ¨æ€è¯»å–ï¼Œç¡®ä¿ç‰ˆæœ¬æ¥æºå•ä¸€ã€‚

```python
# main.py: ç¨‹åºå…¥å£å¤„å¢åŠ æ›´æ–°å¤„ç†é€»è¾‘
import sys, os, time, shutil, subprocess
from godforsaken_save_manager.core import updater

def handle_update():
    if len(sys.argv) > 2 and sys.argv[1] == '--perform-update':
        old_exe_path = sys.argv[2]
        # ç­‰å¾…æ—§è¿›ç¨‹é€€å‡º
        time.sleep(2)
        try:
            shutil.move(sys.executable, old_exe_path)
            # é‡å¯æ›´æ–°åçš„ç¨‹åº
            subprocess.Popen([old_exe_path])
        except Exception as e:
            print(f"Failed to update: {e}") # æœ€å¥½ç”¨æ—¥å¿—æˆ–å¼¹çª—
        finally:
            sys.exit(0)

if __name__ == "__main__":
    handle_update()
    # ... æ­£å¸¸å¯åŠ¨ä¸»ç¨‹åº ...


# updater.py: æ›´æ–°ä¸‹è½½ä¸æ‰§è¡Œé€»è¾‘
import requests, hashlib, tempfile, os, subprocess, sys, locale
from importlib import metadata

try:
    CURRENT_VERSION = metadata.version('godforsaken-save-manager')
except metadata.PackageNotFoundError:
    CURRENT_VERSION = "0.0.0-dev"

VERSION_API = "https://api.github.com/repos/abevol/godforsaken-save-manager/releases/latest"

# ... (check_for_update, verify_file, display_update_info å‡½æ•°ä¿æŒä¸å˜) ...

def download_and_install(info):
    exe_url = info["url"]
    temp_dir = tempfile.gettempdir()
    new_exe_path = os.path.join(temp_dir, "GodForsakenSaveManager_new.exe")

    with requests.get(exe_url, stream=True) as r:
        r.raise_for_status()
        with open(new_exe_path, "wb") as f:
            for chunk in r.iter_content(8192):
                f.write(chunk)

    if not verify_file(new_exe_path, info["sha256"]):
        raise ValueError("æ›´æ–°æ–‡ä»¶æ ¡éªŒå¤±è´¥")

    # å¯åŠ¨æ–°ç‰ˆç¨‹åºæ‰§è¡Œæ›¿æ¢ï¼Œå¹¶ä¼ å…¥å½“å‰ç¨‹åºè·¯å¾„
    subprocess.Popen([new_exe_path, "--perform-update", sys.executable])
    sys.exit(0)
```

---

## 6ï¸âƒ£ ç‰ˆæœ¬ç®¡ç†è§„èŒƒ

| å…ƒç´  | è§„åˆ™ |
| --- | --- |
| **ç‰ˆæœ¬å·æ¥æº** | **`pyproject.toml` å†…çš„ `version` å­—æ®µæ˜¯å”¯ä¸€çœŸå®æ¥æº** |
| Tag æ ¼å¼ | `vX.Y.Z`ï¼ˆä¾‹å¦‚ `v1.5.0`ï¼‰ï¼Œ**å¿…é¡»ä½¿ç”¨é™„æ³¨æ ‡ç­¾ (`git tag -a`)** |
| Tag Message | ä½œä¸º Release Notes çš„å†…å®¹ï¼Œå»ºè®®æ ¼å¼ï¼š`ä¸­æ–‡è¯´æ˜ EN: English notes` |
| å‘å¸ƒåˆ†æ”¯ | ä»… `main` |
| Release åç§° | `Release vX.Y.Z` |
| è¾“å‡ºæ–‡ä»¶ | `GodForsakenSaveManager.exe` |
| ç‰ˆæœ¬å£°æ˜ | `pyproject.toml` + `version.json` |

---

## 7ï¸âƒ£ å®‰å…¨ä¸ç¨³å®šæ€§

| é¡¹ç›®    | æªæ–½                |
| ----- | ----------------- |
| æ–‡ä»¶éªŒè¯  | æ¯æ¬¡æ›´æ–°æ ¡éªŒ SHA256     |
| æ›´æ–°æ¥æº  | ä»…ä¿¡ä»» GitHub å®˜æ–¹ API |
| é˜²ä¸­æ–­æœºåˆ¶ | å…ˆä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶å†æ‰§è¡Œ       |
| æˆæœ¬    | ä½¿ç”¨ GitHub å…è´¹é¢åº¦    |

---

## 8ï¸âƒ£ å¤šè¯­è¨€æ›´æ–°ä¿¡æ¯æ”¯æŒï¼ˆä¸­/è‹±ï¼‰

### âœ³ï¸ åŠŸèƒ½è¯´æ˜

* `version.json` æ”¯æŒ `notes.zh` ä¸ `notes.en` ä¸¤ç§è¯­è¨€ã€‚
* æ„å»ºç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆä¸­è‹±æ–‡æ›´æ–°è¯´æ˜ã€‚
* å®¢æˆ·ç«¯æ ¹æ®ç³»ç»Ÿè¯­è¨€è‡ªåŠ¨é€‰æ‹©æ˜¾ç¤ºä¸­æ–‡æˆ–è‹±æ–‡å†…å®¹ã€‚
* æ—§ç‰ˆä»…å«å­—ç¬¦ä¸² `notes` çš„ JSON ä»å¯è¢«å…¼å®¹è¯†åˆ«ã€‚

### âœ³ï¸ æ•ˆæœ

* ä¸­æ–‡ç³»ç»Ÿç”¨æˆ·ï¼šæ˜¾ç¤ºä¸­æ–‡æ›´æ–°è¯´æ˜ã€‚
* è‹±æ–‡ç³»ç»Ÿç”¨æˆ·ï¼šæ˜¾ç¤ºè‹±æ–‡æ›´æ–°è¯´æ˜ã€‚
* ç»“æ„æ¸…æ™°ï¼Œæ”¯æŒæœªæ¥æ‰©å±•è‡³æ›´å¤šè¯­è¨€ã€‚

---

## âœ… ç»“è®º

è¯¥æ–¹æ¡ˆé€‚ç”¨äº **å…¬å¼€æºç ã€è‡ªåŠ¨åŒ–æ„å»ºã€å…¬å¼€åˆ†å‘** çš„æ¡Œé¢ç¨‹åºï¼š

* è‡ªåŠ¨æ£€æµ‹å¹¶å‘å¸ƒç‰ˆæœ¬ï¼›
* ç”¨æˆ·ç«¯å¯è‡ªåŠ¨æ£€æµ‹æ›´æ–°ï¼›
* é€æ˜ã€å®‰å…¨ã€å…è´¹ï¼›
* æ— éœ€é¢å¤–æœåŠ¡å™¨ï¼›
* æ”¯æŒåç»­ç‰ˆæœ¬æ‰©å±•ã€å¤šè¯­è¨€æ›´æ–°æ—¥å¿—ã€‚
